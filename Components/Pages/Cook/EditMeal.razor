@page "/cook/meals/edit/{Id}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "cook,admin")]
@rendermode InteractiveServer

@using System.IO
@using System.Linq
@using CSE325_visioncoders.Models
@using CSE325_visioncoders.Services
@using Microsoft.AspNetCore.Components.Forms
@using CSE325_visioncoders.Components.Shared

@inject MealService _mealService
@inject ICloudinaryService Cloudinary
@inject NavigationManager Nav
@layout MainLayout

@* <div class="titleBar">
    <img class="titleIcon" src="img/mealIcon.svg" alt="meal icon">
    <a>Edit Meal</a>
</div> *@

<PageHeader Icon="img/mealIcon.svg" Title="Meals" />

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (meal is null)
{
    <p>Loading...</p>
}
else
{
    <div class="meal-form-container">
        <EditForm Model="@meal" OnValidSubmit="SaveChanges">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="meal-form-top">
                <div class="meal-image-box">
                    <div class="meal-image-placeholder">
                        @if (string.IsNullOrWhiteSpace(meal.ImageUrl))
                        {
                            <div class="meals-image-icon">
                                <img src="img/add-image.png" alt="Cook's Hat - Add Image" width="200" />
                            </div>
                            <div class="meal-image-text">Add Image</div>
                        }
                        else
                        {
                            <img src="@meal.ImageUrl" class="meal-image-preview" />
                        }

                        <InputFile OnChange="HandleImageSelected" class="meal-image-input" />
                    </div>
                </div>

                <div class="meal-form-right">
                    <div class="mb-3">
                        <InputText class="form-control meal-input-name"
                                   @bind-Value="meal.Name"
                                   placeholder="Name of the Meal" />
                    </div>

                    <div class="mb-3">
                        <InputTextArea class="form-control meal-input-description"
                                       @bind-Value="meal.Description"
                                       placeholder="Description..." />
                    </div>
                </div>
            </div>

            <div class="meal-ingredients-box">
                <InputTextArea class="form-control meal-input-ingredients"
                               @bind-Value="meal.Ingredients"
                               placeholder="Ingredients" />
            </div>

            <div class="meal-form-buttons">
                <div class="meal-price-input">
                    <label class="me-2">Price:</label>
                    <InputNumber TValue="decimal" class="form-control meal-input-price"
                                 @bind-Value="meal.Price" />
                </div>

                <div class="meal-cook-input">
                    <label class="me-2">Cook:</label>
                    <InputText class="form-control meal-input-cook"
                               @bind-Value="meal.CookName"
                               placeholder="Cook's name" />
                </div>

                <button class="btn btn-primary" type="submit">Save Changes</button>
                <button type="button" class="btn btn-danger ms-2" @onclick="DeleteMeal">Delete Meal</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="GoBack">Back to Meals</button>
            </div>
        </EditForm>
    </div>
}

@code {
    [Parameter] public string Id { get; set; } = default!;
    private Meal? meal;

    // Max file size for meal images (25 MB)
    private const long MaxImageSize = 25L * 1024 * 1024;

    // Error message for image upload issues
    private string? errorMessage;

    // Load meal data on initialization
    protected override async Task OnInitializedAsync()
    {
        meal = await _mealService.GetByIdAsync(Id);
        if (meal is null)
        {
            Nav.NavigateTo("/cook/meals");
        }
    }
    
    // Save changes to the meal
    private async Task SaveChanges()
    {
        if (meal is null) return;

        await _mealService.UpdateAsync(meal);
        Nav.NavigateTo("/cook/meals");
    }

    // Delete the meal
    private async Task DeleteMeal()
    {
        if (meal?.Id is null) return;
        await _mealService.DeleteAsync(meal.Id);
        Nav.NavigateTo("/cook/meals");
    }

    // Navigate back to meals list
    private void GoBack() => Nav.NavigateTo("/cook/meals");

    // Handle image file selection
    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        errorMessage = null;

        if (meal is null) return;

        var file = e.File;
        if (file is null) return;

        var ext = Path.GetExtension(file.Name).ToLowerInvariant();
        var allowed = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp" };
        if (!allowed.Contains(ext))
        {
            errorMessage = "Invalid image type. Please upload a JPG, PNG, GIF, or WEBP file.";
            return;
        }

        if (file.Size > MaxImageSize)
        {
            var sizeMb = file.Size / 1024 / 1024;
            var maxMb = MaxImageSize / 1024 / 1024;
            errorMessage = $"Image is too large ({sizeMb} MB). Max allowed is {maxMb} MB. Please upload a smaller image.";
            return;
        }

        await using var stream = file.OpenReadStream(MaxImageSize);
        try
        {
            var publicUrl = await Cloudinary.UploadAsync(stream, file.Name);
            meal.ImageUrl = publicUrl;
        }
        catch (Exception ex)
        {
            errorMessage = $"Image upload failed: {ex.Message}";
        }
    }
}
