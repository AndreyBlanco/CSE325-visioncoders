@*
  File: Login.razor
  Description: Login page with server-posted form, authenticated redirection,
               error message mapping, and returnUrl propagation.
*@

@page "/login"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@using CSE325_visioncoders.Services
@using CSE325_visioncoders.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthService Auth
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<!-- Title bar -->
<div class="titleBar">
    <img class="titleIcon" src="img/loginIcon.svg" alt="Login icon">
    <a>Login</a>
</div>

<!-- Error message -->
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

<!-- Login form -->
<form method="post" action="@actionUrl" class="loginForm">
    <label>Email</label>
    <input name="Email" />

    <label>Password</label>
    <input name="Password" type="password" />

    <button type="submit" class="btn-login">Login</button>
</form>

@code {
    // State
    private string actionUrl = "";
    private string? errorMessage;

    /// <summary>
    /// Method: OnInitializedAsync
    /// Purpose: Redirects authenticated users, maps query errors to user-friendly messages,
    ///          and builds the form action URL with optional returnUrl.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // Redirect if already authenticated
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            Nav.NavigateTo("/homepage", forceLoad: true);
            return;
        }

        // Parse query for error and returnUrl
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        var error = query.Get("error");
        if (!string.IsNullOrEmpty(error))
        {
            errorMessage = error switch
            {
                "missing" => "Email and password required.",
                "invalid" => "Invalid credentials.",
                _ => "Login failed."
            };
        }

        // Compose action URL
        var returnUrl = query.Get("returnUrl");
        var path = "/auth/login-form";
        if (!string.IsNullOrEmpty(returnUrl))
            path += $"?returnUrl={Uri.EscapeDataString(returnUrl)}";

        actionUrl = Nav.ToAbsoluteUri(path).ToString();
    }
}
