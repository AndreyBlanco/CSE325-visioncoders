@page "/cook/meals"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "cook,admin")]
@rendermode InteractiveServer

@using System.IO
@using System.Linq
@using CSE325_visioncoders.Models
@using CSE325_visioncoders.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject MealService _mealService
@inject IWebHostEnvironment Env
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@layout MainLayout
@using CSE325_visioncoders.Components.Shared

<PageHeader Icon="img/mealIcon.svg" Title="Meals" />

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (!HasMeals && !showForm)
{
    @* EMPTY STATE *@
    <div class="meals-empty">
        <h2>There are no meals added yet</h2>

        <div class="meals-empty-icon">
            <img src="img/empty-meals.png" alt="Empty Meals Icon" width="200" />
        </div>

        <button type="button" class="btn meals-empty-btn" @onclick="ShowForm">
            Add Meal
        </button>
    </div>
}
else if (HasMeals && !showForm)
{
    @* GRID WITH MEAL CARDS + ADD MORE CARD *@
    <div class="meals-grid">
        @foreach (var meal in meals!)
        {
            <div class="meal-card" @onclick="@(() => OnMealClick(meal.Id!))">
                <img src="@GetImage(meal.ImageUrl)" alt="@meal.Name" />
                <div class="meal-card-name">@meal.Name</div>
            </div>
        }

        @* ADD MORE CARD *@
        <div class="meal-card meal-card-add" @onclick="ShowForm">
            <div class="meal-add-plus">+</div>
            <button type="button" class="btn meal-add-btn">Add More</button>
        </div>
    </div>
}

@if (showForm)
{
    @* ADD MEAL FORM *@
    <div class="meal-form-container">
        <EditForm Model="@newMeal" OnValidSubmit="SaveMeal">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="meal-form-top">
                @* Image box with file picker *@
                <div class="meal-image-box">
                    <div class="meal-image-placeholder">
                        @if (string.IsNullOrWhiteSpace(newMeal.ImageUrl))
                        {
                            <div class="meals-image-icon">
                                <img src="img/add-image.png" alt="Cook's Hat - Add Image" width="200" />
                            </div>
                            <div class="meal-image-text">Add Image</div>
                        }
                        else
                        {
                            <img src="@newMeal.ImageUrl" class="meal-image-preview" />
                        }

                        <InputFile OnChange="HandleImageSelected" class="meal-image-input" />
                    </div>
                </div>

                @* Name + Description *@
                <div class="meal-form-right">
                    <div class="mb-3">
                        <InputText class="form-control meal-input-name"
                                   @bind-Value="newMeal.Name"
                                   placeholder="Name of the Meal" />
                    </div>

                    <div class="mb-3">
                        <InputTextArea class="form-control meal-input-description"
                                       @bind-Value="newMeal.Description"
                                       placeholder="Description..." />
                    </div>
                </div>
            </div>

            @* Ingredients full-width *@
            <div class="meal-ingredients-box">
                <InputTextArea class="form-control meal-input-ingredients"
                               @bind-Value="newMeal.Ingredients"
                               placeholder="Ingredients" />
            </div>

            <div class="meal-form-buttons">
                <div class="meal-price-input">
                    <label class="me-2">Price:</label>
                    <InputNumber TValue="decimal" class="form-control meal-input-price"
                                 @bind-Value="newMeal.Price" />
                </div>

                <div class="meal-cook-input">
                    <label class="me-2">Cook:</label>
                    @* Read-only, auto-filled from logged-in cook *@
                    <InputText class="form-control meal-input-cook"
                               @bind-Value="newMeal.CookName"
                               disabled />
                </div>

                <button class="btn btn-primary" type="submit">Save Meal</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="HideForm">
                    Cancel
                </button>
            </div>
        </EditForm>
    </div>
}

@code {
    private Meal newMeal = new();
    private List<Meal>? meals;
    private bool showForm;

    // claim-based cook info
    private string? CookId;
    private string CookDisplayName = "Cook";

    private static string? GetClaim(ClaimsPrincipal user, string type)
        => user?.Claims?.FirstOrDefault(c => c.Type == type)?.Value;

    private async Task LoadAuthAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        CookId = GetClaim(user, ClaimTypes.NameIdentifier)
                 ?? GetClaim(user, "sub")
                 ?? GetClaim(user, "oid")
                 ?? GetClaim(user, "id");

        CookDisplayName = GetClaim(user, ClaimTypes.Name)
                          ?? GetClaim(user, "name")
                          ?? GetClaim(user, "preferred_username")
                          ?? GetClaim(user, "email")
                          ?? "Cook";
    }

    // Max size for uploaded images (25 MB)
    private const long MaxImageSize = 25L * 1024 * 1024;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadAuthAsync();
        meals = await _mealService.GetAsync();
    }

    private bool HasMeals => meals is not null && meals.Any();

    private async Task SaveMeal()
    {
        errorMessage = null;

        // Safety: page is [Authorize], so this SHOULD be set.
        if (string.IsNullOrWhiteSpace(CookId))
        {
            errorMessage = "Unable to determine cook for this account.";
            return;
        }

        // Set cook info from claims
        newMeal.CookId = CookId!;
        if (string.IsNullOrWhiteSpace(newMeal.CookName))
            newMeal.CookName = CookDisplayName;

        await _mealService.CreateAsync(newMeal);

        newMeal = new Meal();
        meals = await _mealService.GetAsync();
        showForm = false;
    }

    private void ShowForm()
    {
        errorMessage = null;

        // Pre-fill cook info into the new meal
        newMeal = new Meal
        {
            CookId = CookId ?? string.Empty,
            CookName = CookDisplayName
        };

        showForm = true;
    }

    private void HideForm()
    {
        showForm = false;
        newMeal = new Meal();
        errorMessage = null;
    }

    private void OnMealClick(string id)
    {
        OpenEditPage(id);
    }

    private void OpenEditPage(string id)
    {
        Nav.NavigateTo($"/cook/meals/edit/{id}");
    }

    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        errorMessage = null;

        var file = e.File;
        if (file is null)
            return;

        var ext = Path.GetExtension(file.Name).ToLowerInvariant();
        var allowed = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp" };

        if (!allowed.Contains(ext))
        {
            errorMessage = "Invalid image type. Please upload a JPG, PNG, GIF, or WEBP file.";
            return;
        }

        if (file.Size > MaxImageSize)
        {
            var sizeMb = file.Size / 1024 / 1024;
            var maxMb = MaxImageSize / 1024 / 1024;
            errorMessage = $"Image is too large ({sizeMb} MB). Max allowed is {maxMb} MB. Please upload a smaller image.";
            return;
        }

        var uploadsFolder = Path.Combine(Env.WebRootPath, "img", "meals");
        Directory.CreateDirectory(uploadsFolder);

        var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
        var filePath = Path.Combine(uploadsFolder, fileName);

        await using var stream = file.OpenReadStream(MaxImageSize);
        await using var fs = File.Create(filePath);
        await stream.CopyToAsync(fs);

        newMeal.ImageUrl = $"img/meals/{fileName}";
    }

    private string GetImage(string? url)
        => string.IsNullOrWhiteSpace(url) ? "img/placeholder-meal.png" : url;
}
